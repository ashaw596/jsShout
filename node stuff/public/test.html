<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link href="css/test.css" rel="stylesheet" type="text/css" >
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script src="js/lib/Cookies-master/cookies.min.js"></script>

<script src="https://cdn.socket.io/socket.io-1.0.6.js"></script>
<script>
    var playerID = "";
    var playerCode = "";
    var setup=false;
    var chatters = {};
	//parse URL tags
	function getUrlVars() {
		var vars = {};
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			vars[key] = value;
		});
		return vars;
	}
	
	var socket = io();
	var gameID = getUrlVars()["gameID"];
    socket.on('disconnect', function(){
        console.log("WHY DID YOU DISCONNECT?");
    });
    var firstConnection = true;
	socket.on('connect', function(){
        //if(firstConnection) {
            playerID = Cookies.get('playerID');
            playerCode = Cookies.get('playerCode');
            //playerCode = "temp";
            socket.emit('authenticate', playerID, playerCode);
            //check if joining a game or making a new game
            if(gameID!=null){
                socket.emit('joinRoom', gameID); //join game room
                //socket.emit('joinGame', gameID);
                $( "#share" ).append( "http://localhost:3000/?gameID=" + gameID );
            }
            else{
                socket.emit('newRoom'); //makes game ID and joins game room
            }
            firstConnection = false;
        //}
        
        
        
	});
	//gets the ID for the new game returned by the server after calling newGame, makes a share link
	socket.on('updateGameID', function (ID) {
		if(gameID==null){
			history.pushState({},document.title,"?gameID=" + ID); //add gameID tag to current url
		}
		$( "#share" ).value( "http://localhost:3000/?gameID=" + ID );
	});
	socket.on('updateAuth', function(id, newCode) {
        playerID = id;
        playerCode = newCode;
        Cookies.set('playerID', playerID);
        Cookies.set('playerCode', playerCode);
    });
    
	$( document ).ready(function() {
		$( "#button1" ).click(function() {
			alert("player: " + playerID + "\nplayerCode: " + playerCode);
		});
        $("#chatLine").focus();
        $("#ans").attr('checked', false);
	});
    
    function addChat(user, message) {
        document.getElementById("chatBox").value +=
            user + ": " + message + "\n";
        $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);

        if(chatters[user]===undefined){
            chatters[user]=[Math.floor((Math.random() * 11) ),Math.floor((Math.random() * 3) )];
        }

        var msg = new SpeechSynthesisUtterance();
        var voices = window.speechSynthesis.getVoices();
        msg.voice = voices[chatters[user][0]]; // Note: some voices don't support altering params
        msg.voiceURI = 'native';
        msg.volume = 1; // 0 to 1
        //msg.rate = 1; // 0.1 to 10
        msg.pitch = chatters[user][1]; //0 to 2
        msg.lang = 'en-US';

        var checked=$("#speak:checked").length;
        if( checked == 1&&setup==true){
            msg.text = message;
            window.speechSynthesis.speak(msg);  
        }
    }
    function resetChat() {
        document.getElementById("chatBox").value = "";
        setup = false;
    }
    
    socket.on('resetChat', function(messages) {
        resetChat();
        messages.forEach(function(message) {
            addChat(message['playerID'], message['message']);
        });
        setup=true;
    });
    
    
    socket.on('getChat', function(user, message) {
        addChat(user, message);
    });
    
    function sendChat() {
        var message = document.getElementById("chatLine").value;
        socket.emit("getChat", message);
        document.getElementById("chatLine").value = "";
    }
    
    socket.on('getMove', function(x1, y1, x2, y2) {
        board1.movePiece(x1,y1,x2,y2,100);
        board1.dragEnabled = true;
    });
    
    
    socket.on("resetMoves", function(moves) {
        board1.clearBoard();
        board1.setupBoard();
        moves.forEach(function(move) {
            board1.movePiece(move['x1'],move['y1'], move['x2'], move['y2'], 0);
        });
    });
    
    var board1;
    (function() {
        window.addEventListener('load', function(){
            var canvas1 = document.getElementById("canvas1");
            var canvas2 = document.getElementById("canvas2");
            var canvas3 = document.getElementById("canvas3");

            var firstDiv = document.getElementById("first");
            //var testDiv = document.getElementById("test");
            var mouseDown = false;
            canvas3.addEventListener('touchend', function(evt) {
                var touchobj = evt.changedTouches[0];
                var mousePos = getMousePos(canvas3, touchobj);
                board1.endMove(mousePos.x, mousePos.y);
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                evt.preventDefault();
              }, false);
            canvas3.addEventListener('touchmove', function(evt) {
                var touchobj = evt.changedTouches[0];
                var mousePos = getMousePos(canvas3, touchobj);
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                //testDiv.innerHTML=message;
                if(board1.isMoving) {
                    board1.drawMovingPiece(mousePos.x, mousePos.y);
                }
                evt.preventDefault();
              }, false);
              
            canvas3.addEventListener('touchstart', function(evt) {
                var touchobj = evt.changedTouches[0];
                var mousePos = getMousePos(canvas3, touchobj);
                board1.startMove(mousePos.x, mousePos.y);
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                evt.preventDefault();
              }, false);
              

            canvas3.addEventListener('mouseup', function(evt) {
                var mousePos = getMousePos(canvas3, evt);
                board1.endMove(mousePos.x, mousePos.y);
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
              }, false);
            canvas3.addEventListener('mousemove', function(evt) {
                var mousePos = getMousePos(canvas3, evt);
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                //console.log(message);
                if(board1.isMoving) {
                    board1.drawMovingPiece(mousePos.x, mousePos.y);
                }
              }, false);
              
            canvas3.addEventListener('mousedown', function(evt) {
                var mousePos = getMousePos(canvas3, evt);
                board1.startMove(mousePos.x, mousePos.y);
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                console.log(message);
              }, false);


        
            start();
        });
    })(); 

    function start() {
        //canvas 3 is in front
        //name, boardCanvas, piecesCanvas, movingCanvas, boardXOffset, boardYOffset, color1, color2
        var onCompleteCallback = function(startSpace, endSpace) {
            socket.emit('getMove', startSpace.x, startSpace.y, endSpace.x, endSpace.y);
            board1.dragEnabled = false;
        }
        board1 = new Board("board1", canvas1, canvas2, canvas3, 50, 0, "#FFCE9E" , "#D18B47", "w", true, onCompleteCallback);
        board1.drawBoard();
        board1.drawPieces();
    }
    
    function changeColor() {
        if (board1.moveColor=="w") {
            board1.moveColor="b";
            document.getElementById("changeColorButton").innerHTML  = "Become White";
        } else {
            board1.moveColor="w";
            document.getElementById("changeColorButton").innerHTML  = "Become Black";
        }
    }
    
</script>

<script src="js/game.js"></script>
<script src="js/setup.js"></script>

</head>
<body>


<div id="first"> 
</div>
<div id="test"> 
    <h1> Bughouse Chess!</h1>
</div>
<div id="viewport" style="height:450px;">
    <canvas id="canvas1" height = "450" width ="450" style="z-index: 0" > </canvas>
    <canvas id="canvas2" height = "450" width ="450" style="z-index: 1"  > </canvas>
    <canvas id="canvas3" height = "450" width ="450" style="z-index: 2"  > </canvas>
</div>

<button name="changeColorButton" id="changeColorButton" onclick="changeColor();">Be Black</button>
<span id="share"></span><br />
<button name="button1" id="button1" >click this!!!</button>
<div name="chat">
    <form action="" onsubmit="sendChat();return false;">
        <table>
        <tr><td>
            <textarea name="chatBox" id="chatBox" rows="20" cols="50"></textarea>
        </td></tr>
        <tr><td>
            <input type="text" name="chatLine" id="chatLine">
            <input type="submit" value="Submit"> <input type="checkbox" name="speak" value="speak" id="speak">Speak
            </td></tr>
        </table>
    </form>
</div>
<script src="js/lib/board.js"></script>
</body>
</html>